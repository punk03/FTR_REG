# Автоматическое обновление FTR Registration System

## Описание

Скрипт `auto-update.sh` предназначен для автоматической проверки и установки обновлений из GitHub репозитория. Скрипт можно запускать вручную или настроить автоматический запуск через cron.

## Возможности

- ✅ Автоматическая проверка наличия обновлений в репозитории
- ✅ Резервное копирование базы данных перед обновлением
- ✅ Обновление кода из GitHub
- ✅ Пересборка backend и frontend
- ✅ Применение миграций базы данных
- ✅ Перезапуск сервисов
- ✅ Проверка здоровья приложения после обновления
- ✅ Защита от одновременного запуска (lock файл)
- ✅ Подробное логирование всех операций
- ✅ Автоматический откат при ошибках

## Использование

### Ручной запуск

```bash
# Перейти в директорию проекта
cd /home/fil/FTR_REG

# Запустить скрипт
./auto-update.sh
```

### Автоматический запуск через cron

#### Вариант 1: Каждые 6 часов

```bash
# Открыть crontab
crontab -e

# Добавить строку (замените /home/fil/FTR_REG на путь к вашему проекту)
0 */6 * * * cd /home/fil/FTR_REG && /bin/bash auto-update.sh >> /dev/null 2>&1
```

#### Вариант 2: Каждый день в 3:00 ночи

```bash
# Открыть crontab
crontab -e

# Добавить строку
0 3 * * * cd /home/fil/FTR_REG && /bin/bash auto-update.sh >> /dev/null 2>&1
```

#### Вариант 3: Каждые 12 часов

```bash
# Открыть crontab
crontab -e

# Добавить строку
0 */12 * * * cd /home/fil/FTR_REG && /bin/bash auto-update.sh >> /dev/null 2>&1
```

### Запуск от root

Скрипт автоматически определяет пользователя приложения и работает корректно даже при запуске от root:

```bash
sudo ./auto-update.sh
```

## Логирование

Все операции логируются в файл:
```
./logs/auto-update_YYYYMMDD.log
```

Пример просмотра логов:
```bash
# Последние 50 строк лога за сегодня
tail -n 50 logs/auto-update_$(date +%Y%m%d).log

# Все логи за сегодня
cat logs/auto-update_$(date +%Y%m%d).log

# Поиск ошибок в логах
grep ERROR logs/auto-update_*.log
```

## Резервные копии

Перед каждым обновлением создается резервная копия базы данных:
```
./backups/backup_YYYYMMDD_HHMMSS.sql.gz
```

## Безопасность

- Скрипт использует lock файл для предотвращения одновременного запуска
- При ошибке выполняется автоматический откат изменений
- Незакоммиченные изменения сохраняются через `git stash`
- Резервная копия базы данных создается перед обновлением

## Проверка статуса

После обновления скрипт проверяет:
- ✅ Доступность backend API (`/api/health`)
- ✅ Доступность frontend (проверка HTML)

## Отличия от update.sh

| Функция | update.sh | auto-update.sh |
|---------|-----------|----------------|
| Проверка обновлений | Нет | ✅ Да |
| Запуск только при наличии обновлений | Нет | ✅ Да |
| Логирование | Минимальное | ✅ Подробное |
| Защита от одновременного запуска | Нет | ✅ Да |
| Автоматический откат | Нет | ✅ Да |
| Предназначение | Ручное обновление | Автоматическое обновление |

## Рекомендации

1. **Первый запуск**: Запустите скрипт вручную для проверки работоспособности
2. **Мониторинг**: Регулярно проверяйте логи на наличие ошибок
3. **Резервные копии**: Периодически проверяйте наличие резервных копий
4. **Частота обновлений**: Рекомендуется проверять обновления не чаще чем раз в 6 часов
5. **Уведомления**: Можно настроить отправку email при ошибках через cron (см. примеры ниже)

## Примеры настройки cron с уведомлениями

### С отправкой email при ошибках

```bash
# В crontab добавить:
0 */6 * * * cd /home/fil/FTR_REG && /bin/bash auto-update.sh 2>&1 | grep -i error | mail -s "FTR Auto-Update Error" admin@example.com
```

### С полным логированием в отдельный файл

```bash
# В crontab добавить:
0 */6 * * * cd /home/fil/FTR_REG && /bin/bash auto-update.sh >> /var/log/ftr-auto-update.log 2>&1
```

## Устранение неполадок

### Скрипт не запускается

1. Проверьте права на выполнение: `chmod +x auto-update.sh`
2. Проверьте, что вы находитесь в правильной директории
3. Проверьте наличие lock файла: `rm /tmp/ftr_auto_update.lock`

### Ошибки при обновлении

1. Проверьте логи: `tail -n 100 logs/auto-update_*.log`
2. Проверьте подключение к интернету
3. Проверьте доступность GitHub репозитория
4. Проверьте наличие свободного места на диске

### Восстановление из резервной копии

```bash
# Остановить приложение
pkill -f "node.*dist/index.js"
pkill -f "serve.*dist"

# Восстановить базу данных
gunzip -c backups/backup_YYYYMMDD_HHMMSS.sql.gz | docker exec -i ftr_postgres psql -U ftr_user -d ftr_db

# Перезапустить приложение
cd backend && npm start &
cd frontend && npx serve -s dist -l 3000 &
```

## Конфигурация

Основные параметры можно изменить в начале скрипта:

```bash
BRANCH="main"              # Ветка для обновления
BACKUP_DIR="./backups"     # Директория для резервных копий
LOG_DIR="./logs"           # Директория для логов
```

